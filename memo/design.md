# seccamp2022 Blue/Green Switcher デザイン
## 概要
- バックボーンネットワークでも Blue/Green デプロイメントがしたい！
    - 2 面の バックボーンネットワークを用意する
    - Blue をユーザが利用しているときは Green を開発する
    - Green の開発が終わったら Green を主系に切り替え，ユーザトラフィックを流す
    - 問題が起きたらすぐに Blue に切り戻す
    - うまく行ったら今度は Blue で開発を行い，開発が終わったら切り替える
- 徐々に切り替えるのが本来だけど，今回はズバっと一気に切り替える

## 基本は vSIX の三角形トポロジー
![topo](./topo.svg)

- Blue で 3 つ，Green で 3 つ
- Blue/Gree は接続しないでそれぞれ独立した三角形を作る
- 三角形のそれぞれの頂点は EX につながる
- 想像以上に複雑なトポロジーになってしまったので，BGP unnum を利用する
- 趣味により，IPv6 Single Stack AS です

## BGP Confederation を使う
- Blue/Green，EX は BGP Confederation を利用して，外部から見ると AS 65000 として振る舞う
- AS 65100/65200/65300 は EX を通して AS 65000 とピアを張る

## Blue/Green の切り替え
- MED 値を利用して切り替える
- SDN Controller が Blue/Green のルータに対して MED の切り替えを行う
- EX，CE は Blue/Green のバックボーンルータ群の MED を尊重するコンフィグを行う

## 戦略
- トポロジーの作成は tinet で行う
    - 先述の通り，基本は BGP Unnumered を利用する
    - アドレス割当，広告するネットワークについては後述
- SDN Controller は k8s の CRD を利用して作成する
    - KloudNFV
- KloudNFV を動作させる環境
    - kind で k8s の環境を作成する
    - Blue/Green の 6 つのルータはホストネットワークとの疎通を持たせるためにブリッジを作成する
        - この線がマネジメントとなり，k8s に疎通する
    - tinet で作成したコンテナを network に指定して，拠点 3 つ * Blue/Green 2 系統 合計 6 つのコントローラを docker-compose.yml に記述
        - このコンテナは docker-in-docker なイメージを利用し，名前で指定して `docker exec -it Blue-A vtysh -c "hogefuga..."` みたいに設定を投入


## 設計情報
- router-id
    - Blue
        - 10.64.60.1
        - 10.64.60.2
        - 10.64.60.3
    - Green
        - 10.64.61.1
        - 10.64.61.2
        - 10.64.61.3
    - ex
        - 10.64.50.1
        - 10.64.50.2
        - 10.64.50.3
    - ce
        - 10.64.70.1
        - 10.64.70.2
        - 10.64.70.3

- BB address
    - 2001:db8:6500::/48 ... AS 65000
        - 2001:db8:6500:100::/56 ... Blue Backbone
            - 2001:db8:6500:100:ace::1/128 ... Blue-A (lo)
            - 2001:db8:6500:100:cafe::1/128 ... Blue-B (lo)
            - 2001:db8:6500:100:beef::1/128 ... Blue-C (lo)
        - 2001:db8:6500:200::/56 ... Green Backbone 
            - 2001:db8:6500:200:ace::1/128 ... Green-A (lo)
            - 2001:db8:6500:200:cafe::1/128 ... Green-B (lo)
            - 2001:db8:6500:200:beef::1/128 ... Green-C (lo)
        - 2001:db8:6500:6451::1/128 ... EX-A
        - 2001:db8:6500:6452::1/128 ... EX-B
        - 2001:db8:6500:6453::1/128 ... EX-C
        - 2001:db8:6500:6471::/64 ... CE-A
            - 2001:db8:6500:6471::1/64 ... CE-A
            - 2001:db8:6500:6471::2/64 ... CM-A
        - 2001:db8:6500:6472::/64 ... CE-B
            - 2001:db8:6500:6472::1/64 ... CE-B
            - 2001:db8:6500:6472::2/64 ... CM-B
        - 2001:db8:6500:6473::/64 ... CE-C
            - 2001:db8:6500:6473::1/64 ... CE-C
            - 2001:db8:6500:6473::2/64 ... CM-C

- 対外アドレス
    - 2001:db8:6520::/48 ... EA-A
        - 2001:db8:6520::1/48 ... EM-A
        - 2001:db8:6520::2/48 ... EM-A
    - 2001:db8:6530::/48 ... EA-B
        - 2001:db8:6530::1/48 ... EM-B
        - 2001:db8:6530::2/48 ... EM-B
    - 2001:db8:6540::/48 ... EA-C
        - 2001:db8:6540::1/48 ... EM-C
        - 2001:db8:6540::2/48 ... EM-C